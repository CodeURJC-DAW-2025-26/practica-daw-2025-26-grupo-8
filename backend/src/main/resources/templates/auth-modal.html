<div class="modal fade" id="authModal" tabindex="-1" aria-labelledby="authModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 shadow-lg overflow-hidden rounded-4">
            <button type="button" class="btn-close position-absolute top-0 end-0 m-3 z-3" data-bs-dismiss="modal"
                aria-label="Close"></button>

            <div class="modal-body p-0">
                <div class="row g-0">

                    <div class="col-md-5 d-none d-md-block">
                        <img src="/assets/images/inicio-sesion_resized.jpg" alt="Login" class="img-fluid w-100 h-100"
                            style="object-fit: cover; min-height: 450px;">
                    </div>

                    <div class="col-12 col-md-7 p-4 p-md-5 d-flex flex-column justify-content-center">

                        <div id="loginForm">
                            <h2 class="fw-bold mb-4 title-font text-primary-custom">¡Hola de nuevo!</h2>

                            <div id="loginError" class="alert alert-warning d-none small py-2"></div>

                            <form action="/login" method="POST">
                                <div class="mb-3">
                                    <label class="form-label small text-muted">Correo o Usuario</label>
                                    <input type="text" name="username" class="form-control" required>
                                </div>
                                <div class="mb-4">
                                    <label class="form-label small text-muted">Contraseña</label>
                                    <input type="password" name="password" class="form-control" required>
                                </div>
                                <div class="d-grid mb-3">
                                    <button type="submit" class="btn btn-primary btn-custom py-2">Entrar</button>
                                </div>
                                <div class="text-center">
                                    <p class="small text-muted mb-0">¿No tienes cuenta?</p>
                                    <a href="#" class="fw-bold text-primary-custom text-decoration-none"
                                        onclick="toggleAuth('register')">Regístrate aquí</a>
                                </div>
                            </form>
                        </div>

                        <div id="registerForm" class="d-none">
                            <h2 class="fw-bold mb-4 title-font text-primary-custom">Crear Cuenta</h2>

                            <div id="registerError" class="alert alert-danger d-none small py-2"></div>

                            <form action="/register" method="POST" id="registerFormElement">
                                <div class="mb-3">
                                    <label class="form-label small text-muted">Nombre Completo</label>
                                    <input type="text" name="name" class="form-control" placeholder="Ej: Juan Pérez"
                                        required>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label small text-muted">Correo Electrónico</label>
                                    <input type="email" name="email" class="form-control" placeholder="juan@ejemplo.com"
                                        required>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label small text-muted">Contraseña</label>
                                    <input type="password" name="password" id="regPassword" class="form-control"
                                        required minlength="4">
                                </div>

                                <div class="mb-4">
                                    <label class="form-label small text-muted">Repetir Contraseña</label>
                                    <input type="password" name="confirmPassword" id="regConfirmPassword"
                                        class="form-control" required minlength="4">
                                    <div class="invalid-feedback">Las contraseñas no coinciden.</div>
                                </div>

                                <div class="d-grid mb-3">
                                    <button type="submit" class="btn btn-primary btn-custom py-2">Registrarse</button>
                                </div>
                                <div class="text-center">
                                    <p class="small text-muted mb-0">¿Ya tienes cuenta?</p>
                                    <a href="#" class="fw-bold text-primary-custom text-decoration-none"
                                        onclick="toggleAuth('login')">Inicia sesión</a>
                                </div>
                            </form>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {

        // --- 1. CLIENT-SIDE VALIDATION: Check if passwords match ---
        const pass1 = document.getElementById('regPassword');
        const pass2 = document.getElementById('regConfirmPassword');

        if (pass1 && pass2) {
            pass2.addEventListener('input', function () {
                if (pass1.value !== pass2.value) {
                    // This triggers HTML5 built-in validation styling
                    pass2.setCustomValidity("Las contraseñas no coinciden");
                    pass2.classList.add("is-invalid");
                } else {
                    pass2.setCustomValidity("");
                    pass2.classList.remove("is-invalid");
                }
            });

            pass1.addEventListener('input', function () {
                if (pass2.value && pass1.value !== pass2.value) {
                    pass2.setCustomValidity("Las contraseñas no coinciden");
                    pass2.classList.add("is-invalid");
                } else {
                    pass2.setCustomValidity("");
                    pass2.classList.remove("is-invalid");
                }
            });
        }

        // --- 2. SERVER-SIDE VALIDATION: Read URL errors ---
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('error')) {
            const errorType = urlParams.get('error');

            // Auto-open the modal if there's an error
            const authModalElement = document.getElementById('authModal');
            if (authModalElement) {
                const authModal = new bootstrap.Modal(authModalElement);
                authModal.show();
            }

            const errorDiv = document.getElementById('registerError');

            if (errorType === 'email_exists') {
                // Switch to register view (assuming your toggleAuth function does this)
                if (typeof toggleAuth === "function") toggleAuth('register');

                // Show the error message
                errorDiv.textContent = "Ya existe un usuario con este correo electrónico.";
                errorDiv.classList.remove('d-none');
            } else if (errorType === 'password_mismatch') {
                if (typeof toggleAuth === "function") toggleAuth('register');
                errorDiv.textContent = "Las contraseñas enviadas no coinciden.";
                errorDiv.classList.remove('d-none');
            }
        }
    });
</script>